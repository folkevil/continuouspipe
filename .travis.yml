language: php

dist: xenial
sudo: false

matrix:
    include:
        - php: 7.1

env:
    global:
        - DATABASE_HOST=127.0.0.1
        - DATABASE_USER=root
        - DATABASE_PASSWORD=
        - REDIS_HOST=127.0.0.1

services:
    - docker
    - mysql
    - redis-server

before_install:
    - sudo apt-get install -y librabbitmq-dev
    - printf "\n" | pecl install amqp

install:
    - pushd api && composer install && popd

script:
    - source .env.dist

    # API tests
    - pushd api/
    - vendor/bin/phpspec --no-interaction run
    - vendor/bin/phpunit
    - vendor/bin/behat --profile=domain -fprogress

    - bin/console doctrine:database:create --no-interaction
    - bin/console doctrine:migrations:migrate --no-interaction
    - vendor/bin/behat --profile=smoke -fprogress
    - popd

    # Shell script tests
    - for file in $(find . -type f \( -perm +111 -or -name "*.sh" \) ! -path "*/vendor/*" ! -path "*/.git/*" ! -path "*/api/bin/console" ! -path "*/api/bin/symfony_requirements" | sed 's#^\.#/app#'); do docker run -v "$(pwd):/app" koalaman/shellcheck:v0.4.7 --exclude SC1091 "$file"; done
